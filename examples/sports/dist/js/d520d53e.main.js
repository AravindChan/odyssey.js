function getParameterByName(a){a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var b=new RegExp("[\\?&]"+a+"=([^&#]*)"),c=b.exec(location.search);return null==c?"":decodeURIComponent(c[1].replace(/\+/g," "))}function sanitizeCountry(a){var b=a.toLowerCase();return b=b.replace(new RegExp("\\s","g"),"-"),b=b.replace(new RegExp("[àáâãäå]","g"),"a"),b=b.replace(new RegExp("æ","g"),"ae"),b=b.replace(new RegExp("ç","g"),"c"),b=b.replace(new RegExp("[èéêë]","g"),"e"),b=b.replace(new RegExp("[ìíîï]","g"),"i"),b=b.replace(new RegExp("ñ","g"),"n"),b=b.replace(new RegExp("[òóôõö]","g"),"o"),b=b.replace(new RegExp("œ","g"),"oe"),b=b.replace(new RegExp("[ùúûü]","g"),"u"),b=b.replace(new RegExp("[ýÿ]","g"),"y"),b=b.replace(new RegExp("\\W","g"),"-"),b=b.replace(new RegExp("'","g"),"-")}function torque(a){function b(){}return b.reach=function(b){function c(a,b){function c(a){return 10>a?"0"+a:a}a=a.getTime?a.getTime():a,b=b.getTime?b.getTime():b;var d=(b-a)/1e3,e=86400,f=31*e*12;return e>d?function(a){return c(a.getUTCHours())+":"+c(a.getUTCMinutes())}:f>d?function(a){return c(a.getUTCMonth()+1)+"/"+c(a.getUTCDate())+"/"+c(a.getUTCFullYear())}:function(a){return c(a.getUTCMonth()+1)+"/"+c(a.getUTCFullYear())}}function d(b){var d=a.getTimeBounds();if(d){if("date"!==d.columnType)return b;if(d&&void 0!==d.start){var e=c(d.start,d.end);if(!_.isNaN(a.stepToTime(b).getYear()))return e(a.stepToTime(b))}}}function e(a){0===a.step&&($(".Scoreboard-number").removeClass("is-visible"),$(".Scoreboard-number--0").addClass("is-visible"));var b=100*a.step/1440;$(".progress").width(b+"%"),a.step>=f-5&&a.step<f+5?(g.trigger(),q&&!q.is(":visible")&&q.show().animate({marginRight:0,opacity:1},150),u&&!u.is(":visible")&&(u.siblings(".Scoreboard-number").removeClass("is-visible"),u.addClass("is-visible"))):a.step>=f+5&&a.step<f+10&&setTimeout(function(){q&&q.animate({marginRight:-30,opacity:0},150,function(){$(this).appendTo($(".Notifications > ul")),$(this).hide()})},6e3)}var f=b.get("step").value;TIME||($(".Footer-time--l").text(d(0)),$(".Footer-time--r").text(d(a.options.steps)),TIME=!0);var g=O.Trigger({}),h=b.html().split("<h1>")[1].split("</h1>")[0],i=h.split("+")[0],j=h.split("+")[1],k="true"===h.split("+")[2],l=b.html().split("<h2>")[1].split("</h2>")[0],m=b.html().split("</h2>")[1];if(k){var n=f*$(".slider").width()/a.options.steps,o=['<div class="slide-tip slide-tip-'+f+" slide-tip-"+j+" slide-tip-"+i+'" style="left:'+n+'px">','<div class="tooltip">',"<h2>"+d(f)+"</h2>"+(l?"<p>"+l+"</p>":""),"</div>","</div>"].join("\n");$(".slider").append(o)}if("slide"===i){var p=['<li class="Notification Notification_'+f+'">','<div class="Notification-text">','<p class="Notification-time">'+d(f)+"</p>",'<div class="Notification-content">'+(l?"<h2>"+l+"</h2>":""),"<p>"+m+"</p>","</div>","</li>"].join("\n");$(".Notifications > ul").append(p);var q=$(".Notification_"+f)}if("score"===i){var r=$(".Scoreboard-team--"+j+" .Scoreboard-number").last(),s=parseInt(r.text(),10),t='<p class="Scoreboard-number Scoreboard-number--'+(s+1)+" Scoreboard-number_"+f+'">'+(s+1)+"</p>";$(".Scoreboard-team--"+j+" .Scoreboard-count").append(t);var u=$(".Scoreboard-number_"+f)}$(".slide-tip").on("mouseenter",function(){$(this).find(".tooltip").fadeIn(150)}).on("mouseleave",function(){$(this).find(".tooltip").fadeOut(150)});var v=$(".slide-tip-"+f+" .tip"),w=($(".slide-tip-"+f+" .tooltip"),v.width()/2);return v.css({margin:-w}),a.on("change:time",e),g.clear=function(){a.off("change:time",e)},g},b.pause=function(){return O.Action(function(){a.pause()})},b.play=function(){return O.Action(function(){a.play()})},b}var USER=getParameterByName("user"),TABLE_NAME=getParameterByName("table_name"),VIZJSON=getParameterByName("vis"),VIZJSON_URL,TITLE=getParameterByName("title"),DESCRIPTION=getParameterByName("description"),DURATION=getParameterByName("duration"),TEAM1=_.escape(getParameterByName("t").split("|")[0].split(",")[0]),TEAM1_COLOR="#"+_.escape(getParameterByName("t").split("|")[0].split(",")[1]),TEAM1_SANITIZED=sanitizeCountry(TEAM1),TEAM2=_.escape(getParameterByName("t").split("|")[1].split(",")[0]),TEAM2_COLOR="#"+_.escape(getParameterByName("t").split("|")[1].split(",")[1]),TEAM2_SANITIZED=sanitizeCountry(TEAM2),TIME=!1;O.Template({init:function(){if($(window).on("hashchange",function(){window.location.reload(!0)}),USER&&VIZJSON){VIZJSON_URL="http://"+USER+".cartodb.com/api/v2/viz/"+VIZJSON+"/viz.json";var a=["```",'-title: "'+TITLE+'"','-author: "author"','-vizjson: "'+VIZJSON_URL+'"',"-duration: "+DURATION||30,"```","\n"].join("\n"),b=new cartodb.SQL({user:USER});b.execute("SELECT * FROM "+TABLE_NAME+" ORDER BY step ASC").done(function(b){for(var c=b.rows,d=0;d<c.length;++d){var e=c[d],f=["#"+e.name+"+"+e.team+"+"+e.visible,"```\n-step: "+e.step+"\n"+(e.info?e.info+"\n":"")+"```","##"+e.title,e.description].join("\n");a=a+"\n\n"+f}var g=location.hash,h=g.split("/");!g||g&&!h[2].length?O.Template.Storage.save(a.replace(/"/g,"'"),"torque"):($(".Scoreboard-team--1 .team-marker").css({background:TEAM1_COLOR}),$(".Scoreboard-team--2 .team-marker").css({background:TEAM2_COLOR}),$(".Scoreboard-team--1 .Scoreboard-title").text(TEAM1),$(".Scoreboard-team--2 .Scoreboard-title").text(TEAM2))})}},_initActions:function(a){for(var b=0;b<a.length;++b){var c=a[b],d=O.Parallel(O.Actions.CSS($(".Notifications")).addClass("is-visible"),this.slides.activate(b),c(this));if(!c.get("step"))return;this.story.addState(torque(this.torqueLayer).reach(c),d)}},update:function(a){var b=this;cdb.vis.Loader.get(VIZJSON_URL,function(c){TITLE=c.title,DESCRIPTION=c.description,document.title=TITLE,$("meta[name=description]").attr("content",DESCRIPTION),$(".Footer-infoTitle").text(TITLE);for(var d=(b.map=L.map("map").fitBounds(c.bounds),"http://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png"),e=(L.tileLayer(d,{attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="http://cartodb.com/attributions">CartoDB</a>'}).addTo(b.map),b.slides=O.Actions.Slides("slides"),b.story=O.Story(),0);e<c.layers.length;++e)"torque"===c.layers[e].type&&cartodb.createLayer(b.map,c,{layerIndex:e}).done(function(c){b.torqueLayer=c,b.torqueLayer.stop(),b.map.addLayer(b.torqueLayer),b.torqueLayer.on("change:steps",function(){b.torqueLayer.play(),b.torqueLayer.actions=torque(b.torqueLayer),b._initActions(a)})}).on("error",function(a){throw new Error("Some error occurred: "+a)})})}});